# kustomize-action [![ts](https://github.com/int128/kustomize-action/actions/workflows/ts.yaml/badge.svg)](https://github.com/int128/kustomize-action/actions/workflows/ts.yaml)

This is an action to run `kustomize build` in parallel.
`kustomize build` takes a long time if it loads an external resource such as HTTPS or Git.
This action would reduce time by paralell build.


## Getting Started

To run this action:

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: int128/kustomize-action@v1
        id: kustomize
        with:
          kustomization: overlays/*/kustomization.yaml
      - run: find ${{ steps.kustomize.outputs.directory }}
```

If `kustomization` matches to the following files,

```
overlays/development/kustomization.yaml
overlays/production/kustomization.yaml
```

this action writes the generated manifests to a temporary directory.
You can get the paths from `outputs.files`, for example,

```
/tmp/kustomize-action-xyz/overlays/development/generated.yaml
/tmp/kustomize-action-xyz/overlays/production/generated.yaml
```

You can get the base directory from `outputs.directory`, for example,

```
/tmp/kustomize-action-xyz
```


### Post a comment on error

If `kustomize build` returned an error, this action will post a comment to a pull request.

![image](https://user-images.githubusercontent.com/321266/127739402-5f9c6388-bf84-48fe-b7a7-45aed0a7dbfe.png)


### Write individual files

You can set `write-individual-files` to write individual files (see [kustomize#960](https://github.com/kubernetes-sigs/kustomize/pull/960)).

```yaml
      - uses: int128/kustomize-action@v1
        with:
          kustomization: overlays/*/kustomization.yaml
          write-individual-files: true
```

This action writes the individual manifests as follows:

```
/tmp/kustomize-action-xyz/overlays/development/apps_v1_deployment_echoserver.yaml
/tmp/kustomize-action-xyz/overlays/development/v1_service_echoserver.yaml
/tmp/kustomize-action-xyz/overlays/production/apps_v1_deployment_echoserver.yaml
/tmp/kustomize-action-xyz/overlays/production/v1_service_echoserver.yaml
```


### Copy extra files

You can set `extra-files` to copy the extra files with the results of `kustomize build`.

```yaml
      - uses: int128/kustomize-action@v1
        with:
          kustomization: overlays/*/kustomization.yaml
          extra-files: overlays/*/metadata.yaml
```

This action writes the generated manifests with the extra files as follows:

```
/tmp/kustomize-action-xyz/overlays/development/generated.yaml
/tmp/kustomize-action-xyz/overlays/development/metadata.yaml
/tmp/kustomize-action-xyz/overlays/production/generated.yaml
```


## Inputs

| Name | Required | Description
|------|----------|------------
| `kustomization` | yes | glob patterns to `kustomization.yaml`
| `extra-files` | no | glob patterns to extra files to copy
| `base-directory` | no | base directory to compute a relative path to `kustomization.yaml` (default to workspace)
| `max-process` | no | max number of kustomize processes (default to 5)
| `write-individual-files` | no | set true to write individual files (default to `false`)
| `error-comment-header` | no | header in a comment to post on error
| `error-comment-footer` | no | footer in a comment to post on error
| `token` | no | GitHub token to post a comment on error


## Outputs

| Name | Description
|------|------------
| `directory` | directory to results of `kustomize build`
| `files` | multi-line string of files generated by `kustomize build`
