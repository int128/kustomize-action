name: kustomize-diff-action
description: run kustomize build and diff between head and base ref

inputs:
  kustomization:
    description: glob patterns to kustomization.yaml
    required: true
  write-individual-files:
    description: set true to write individual files (optional)
    required: false
    default: 'false'
  token:
    description: GitHub token (optional)
    required: true
    default: ${{ github.token }}

runs:
  using: composite
  steps:
    - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      with:
        ref: ${{ github.base_ref }}
        path: _base_ref

    - uses: int128/kustomize-action@0cee5b04618e94b05b3c97d5ba7aa12d00bf4a77 # v1.102.0
      id: kustomize-head
      with:
        token: ${{ inputs.token }}
        write-individual-files: ${{ inputs.write-individual-files }}
        kustomization: ${{ inputs.kustomization }}

    - uses: int128/kustomize-action@0cee5b04618e94b05b3c97d5ba7aa12d00bf4a77 # v1.102.0
      id: kustomize-base
      with:
        token: ${{ inputs.token }}
        base-directory: _base_ref
        write-individual-files: ${{ inputs.write-individual-files }}
        kustomization: ${{ inputs.kustomization }}
        ignore-kustomize-error: true

    - uses: int128/diff-action@915c60aa5cb5c973f5f39d1e59cff13bc1fa3c6e # v1.40.0
      with:
        token: ${{ inputs.token }}
        base: ${{ steps.kustomize-base.outputs.directory }}
        head: ${{ steps.kustomize-head.outputs.directory }}
